# CF-EMBY-PROXY-UI

#### **æè¿°**

cf-emby-proxy-uiå®ƒæ˜¯ä¸€ä¸ªåä»£EMBYå®ç°åŠ é€Ÿä»¥åŠEMBYæºç«™IPéšè—çš„é¡¹ç›®ã€‚é‰´æƒä½¿ç”¨çš„æ˜¯ç®¡ç†å‘˜å¯†ç +JWTå¯†é’¥çš„ç»„åˆï¼Œä¸æ‰‹åŠ¨è®¾ç½®JWTå¯†é’¥ï¼ŒJWTå¯†é’¥ä¼šé€€å›åˆ°ä¸ç®¡ç†å‘˜å¯†é’¥ç›¸åŒã€‚æœ‰é¢æ¿å¯ä»¥è®¾ç½®å¤šä¸ªåä»£ï¼ŒåŒæ—¶ä¹Ÿæä¾›äº†ä»£ç†æ•°æ®çš„å¯¼å…¥å’Œå¯¼å‡ºã€‚

---



#### **åŸç†**

**æµé‡è½¬å‘åŸç†**ï¼šå®¢æˆ·ç«¯é€šè¿‡ä»£ç†é“¾æ¥å‘é€è¯·æ±‚åˆ°WorkeræŒ‡å®šè®¿é—®EMBYæºç«™ï¼ŒWorker ä½œä¸ºä¸€ä¸ªä¸­é—´äººï¼Œä¸€æ–¹é¢ä¿®æ”¹è¯·æ±‚å¤´å¹¶å‘é€è¯·æ±‚åˆ°EMBYæºç«™ï¼Œä¸€æ–¹é¢æ¥å—æºç«™çš„æ•°æ®ä»¥æµå¼ä¼ è¾“é€ä¼ ç»™å®¢æˆ·ç«¯ã€‚HTTP(S)åè®®è¯·æ±‚ä¼ è¾“ï¼ŒWSåè®®ä¿æŒå¿ƒè·³è¿æ¥ç­‰

**IPéšè—åŸç†**ï¼šå€Ÿç”¨Cloudflare çš„è¾¹ç¼˜ç½‘ç»œå®ç°éšè—EMBYæºç«™çœŸå®IPéšè—ï¼Œèµ·åˆ°éšè—å’Œä¿æŠ¤EMBYæºç«™çš„ä½œç”¨

---



#### **éœ€æ±‚å‰æ**

**ä¸æƒ³æš´éœ²EMBYæºç«™çš„çœŸå® IP**

**è®¿é—®EMBYæºç«™ç›´è¿å·®ã€EMBYæºç«™åœ¨å›½å¤–ï¼Œçº¿è·¯ä¸å¥½ã€‘**  åˆ©ç”¨cloudflareåŠ é€Ÿè®¿é—®

**å¤šå°æœåŠ¡å™¨æƒ³ç»Ÿä¸€å…¥å£ã€å¤šå°æœåŠ¡å™¨éœ€è¦EMBYåä»£ã€‘**ï¼Œè·¯ç”±åˆ†æµï¼ŒURLè·¯å¾„åˆ†æµã€‚



**å†…ç½‘ä¸éœ€è¦**

**è…ç«¹ä¸éœ€è¦**

**EMBYæºç«™æ˜¯å›½å†…æœºå™¨/CN2ï¼Œè¿™ç±»ç›´è¿é¡¶çº§çº¿è·¯ä¸éœ€è¦**

---



#### **éƒ¨ç½²å‰æ**

**embyè…ç«¹è®©ä¸è®©åä»£ï¼Ÿ**è¯¢é—®è…ç«¹è®©ä¸è®©åä»£ï¼Ÿ

**å®¢æˆ·ç«¯æ”¯ä¸æ”¯æŒåä»£ï¼Ÿ**å®¢æˆ·ç«¯å¯ä»¥é€‰æ‹©å°å¹»,hills,vidhub,senplayer,forward,afusekt,yamby ã€æˆ‘æµ‹è¯•çš„hillsæ²¡æœ‰é—®é¢˜ã€‘

**æ»¥ç”¨çš„è¯cloudflareå¯èƒ½ä¼šæš‚åœè´¦å·åŠŸèƒ½æˆ–æ˜¯å°å·ã€‚** ï¼Œé¡¹ç›®å·²è®¾ç½® `Cache-Control: no-store` å¹¶ç¦ç”¨äº† Cloudflare å¯¹æµåª’ä½“æ–‡ä»¶çš„ç¼“å­˜ï¼Œç¬¦åˆ Cloudflare æœåŠ¡æ¡æ¬¾ä¸­å…³äºâ€œé HTML å†…å®¹ç¼“å­˜â€çš„è§„å®šã€‚ ä½†è¯·æ³¨æ„ï¼šå¦‚æœæ‚¨çš„æ—¥å‡æµé‡è¿‡å¤§ï¼ˆå¦‚ TB çº§åˆ«ï¼‰ï¼Œä»å¯èƒ½å› å ç”¨è¿‡å¤šå¸¦å®½è¢« Cloudflare åˆ¤å®šä¸ºæ»¥ç”¨ï¼ˆSection 2.8ï¼‰ã€‚**å»ºè®®ä»…ç”¨äºä¸ªäººæˆ–å®¶åº­åˆ†äº«**ã€‚

**EMBYæºç«™è‡ªå®šä¹‰WEBç«¯è·¯å¾„**ï¼Œä»£ç å¤ªæ­»æ¿æ— æ³•è‡ªåŠ¨åŒ¹é…è·¯å¾„ã€‚åªä¼šåŒ¹é…/web/index.html

**çœ‹è§†é¢‘é€ æˆçš„Workerè¯·æ±‚æ•°é‡åé«˜ï¼Œ**è€ƒè™‘æ˜¯å¦å½±å“å…¶ä»–worker

---

#### åŸŸåè®¾ç½®

##### ã€å¯é€‰ã€‘**DNSè®°å½•**

- æ·»åŠ ä¸€æ¡**CNAMEè§£æ** åç§°ï¼šembyproxy(è‡ªå®šä¹‰) å†…å®¹ï¼šsaas.sin.fan(è‡ªå®šä¹‰ä¼˜é€‰åŸŸå)ï¼Œworkeræ·»åŠ è·¯ç”±æŒ‡å®šå½“å‰åŸŸï¼Œå½“å‰åŸŸååé¢/*ã€ä¸è¦å¸¦https://ã€‘

##### **SSL/TLS** 

---æ¦‚è¿°

- é€‰æ‹©**å®Œå…¨** ã€ä¸è¦é€‰ä¸¥æ ¼ã€‘

---è¾¹ç¼˜è¯ä¹¦  

- **å§‹ç»ˆä½¿ç”¨ HTTPS**  
- **æœ€ä½ TLS ç‰ˆæœ¬ **é€‰æ‹©TLS1.2 
- **éšæœºåŠ å¯† TLS 1.3** 
- **è‡ªåŠ¨ HTTPS é‡å†™**

##### é€Ÿåº¦
---è®¾ç½®

- å¼€å¯**ç«™ç‚¹æ¨èè®¾ç½®**


--- Smart Shield

- **Smart Shield** å¼€å¯

##### ç¼“å­˜

---é…ç½®

-  å¼€å¯ æµè§ˆå™¨ç¼“å­˜ TTL ã€ä¸€å¤©æˆ–å¾ˆä¹…ã€‘


---Tiered Cache

- å¼€å¯**Tiered Cache**


#####  ç½‘ç»œ

- å¼€å¯**WebSockets**


---

#### **ç¯å¢ƒå˜é‡ä¸€è§ˆ**

| **å˜é‡å**   | **å¿…å¡«** | **ä½œç”¨**                                                     | **ç¤ºä¾‹**              |
| ------------ | -------- | ------------------------------------------------------------ | --------------------- |
| `ENI_KV`     | âœ…        | **å¿…é¡»åœ¨åå°ç»‘å®š KV Namespace**ï¼Œä»£ç è¯»å†™æ•°æ®çš„æ•°æ®åº“ã€‚      | (é€‰æ‹©ç»‘å®šçš„ KV)       |
| `ADMIN_PASS` | âœ…        | åå°ç®¡ç†ç•Œé¢çš„ç™»å½•å¯†ç ã€‚                                     | `MySuperPass123`      |
| `JWT_SECRET` | âŒ        | ç”¨äºåŠ å¯† Cookie çš„ç›å€¼ã€‚ä¸å¡«åˆ™é»˜è®¤ç­‰äº `ADMIN_PASS`ã€‚ä¿®æ”¹æ­¤é¡¹ä¼šå¯¼è‡´æ‰€æœ‰å·²ç™»å½•ç”¨æˆ·æ‰çº¿ã€‚ | `ComplexRandomString` |

---

####  éƒ¨ç½²æŒ‡å— (Step-by-Step)

##### ç¬¬ä¸€æ­¥ï¼šåˆ›å»º KV å‘½åç©ºé—´

1. ç™»å½• Cloudflare Dashboardã€‚
2. è¿›å…¥ **Workers & Pages** -> **KV**ã€‚
3. ç‚¹å‡» **Create a Namespace**ã€‚
4. å‘½åä¸º `EMBY_DATA` (æˆ–è€…ä»»ä½•ä½ å–œæ¬¢çš„åå­—)ï¼Œç‚¹å‡» Addã€‚

##### ç¬¬äºŒæ­¥ï¼šåˆ›å»º Worker

1. è¿›å…¥ **Workers & Pages** -> **Overview** -> **Create Application**ã€‚
2. ç‚¹å‡» **Create Worker**ï¼Œå‘½åå»ºè®®ä¸º `emby-proxy`ï¼Œç‚¹å‡» Deployã€‚
3. ç‚¹å‡» **Edit code**ï¼Œå°†æœ¬é¡¹ç›®æä¾›çš„ `worker.js` ä»£ç å®Œæ•´å¤åˆ¶è¿›å»ã€‚
4. ä¿å­˜å¹¶éƒ¨ç½²ã€‚

##### ç¬¬ä¸‰æ­¥ï¼šç»‘å®š KV æ•°æ®åº“ (å…³é”®)

1. åœ¨ Worker çš„è®¾ç½®é¡µé¢ï¼Œç‚¹å‡» **Settings** -> **Variables**ã€‚
2. å‘ä¸‹æ»šåŠ¨åˆ° **KV Namespace Bindings**ã€‚
3. ç‚¹å‡» **Add Binding**ã€‚
4. **Variable name** å¡«å†™ï¼š`ENI_KV` (**æ³¨æ„ï¼šå¿…é¡»å®Œå…¨ä¸€è‡´**)ã€‚
5. **KV Namespace** é€‰æ‹©ç¬¬ä¸€æ­¥åˆ›å»ºçš„ `EMBY_DATA`ã€‚
6. ç‚¹å‡» **Save and Deploy**ã€‚

##### ç¬¬å››æ­¥ï¼šè®¾ç½®å¯†ç 

1. è¿˜åœ¨ **Settings** -> **Variables** é¡µé¢ã€‚

2. åœ¨ **Environment Variables** åŒºåŸŸç‚¹å‡» **Add Variable**ã€‚

3. **Variable name** å¡«å†™ï¼š`ADMIN_PASS`ã€‚**Value** å¡«å†™ä½ çš„åå°ç™»å½•å¯†ç ã€‚

4. **Variable name** å¡«å†™  `JWT_SECRET`  **Value** å¡«å†™éšæœºç”Ÿæˆå­—ç¬¦ä¸²ã€‚

5. ç‚¹å‡» **Encrypt** (åŠ å¯†å­˜å‚¨)ï¼Œç„¶å **Save and Deploy**ã€‚

---

   #### ğŸ“– ä½¿ç”¨è¯´æ˜

##### 1. è¿›å…¥ç®¡ç†åå°

è®¿é—®åœ°å€ï¼š`https://ä½ çš„WorkeråŸŸå/admin`

* è¾“å…¥åœ¨ç¯å¢ƒå˜é‡ä¸­è®¾ç½®çš„å¯†ç ç™»å½•ã€‚
* å¦‚æœè¿ç»­è¾“é”™ 5 æ¬¡ï¼ŒIP å°†è¢«é”å®š 15 åˆ†é’Ÿã€‚

##### 2. æ·»åŠ ä»£ç†èŠ‚ç‚¹

åœ¨åå°å·¦ä¾§é¢æ¿è¾“å…¥ï¼š

* **ä»£ç†åç§°**ï¼šä¾‹å¦‚ `HK` (ä»…é™å°å†™è‹±æ–‡/æ•°å­—)ã€‚
* **è®¿é—®å¯†é’¥** (å¯é€‰)ï¼šä¾‹å¦‚ `123`ã€‚å¦‚æœç•™ç©ºï¼Œåˆ™å…¬å¼€è®¿é—®ã€‚
* **æœåŠ¡å™¨åœ°å€**ï¼šEmby æºç«™åœ°å€ï¼Œä¾‹å¦‚ `http://1.2.3.4:8096` (ä¸è¦å¸¦ç»“å°¾çš„ `/`)ã€‚

ç‚¹å‡» **ç«‹å³éƒ¨ç½²**ã€‚

##### 3. å®¢æˆ·ç«¯è¿æ¥

* **å…¬å¼€èŠ‚ç‚¹**ï¼š`https://ä½ çš„WorkeråŸŸå/HK`

* **åŠ å¯†èŠ‚ç‚¹**ï¼š`https://ä½ çš„WorkeråŸŸå/HK/123`

  åªéœ€è¦æŠŠåŸæ¥çš„**EMBYæºç«™é“¾æ¥**æ¢æˆ**èŠ‚ç‚¹è¿æ¥**ä½¿ç”¨

##### 4. æ•°æ®å¤‡ä»½

* ç‚¹å‡»åˆ—è¡¨å³ä¸Šè§’çš„ **å¯¼å‡º** æŒ‰é’®ï¼Œå¯ä¸‹è½½ `json` å¤‡ä»½æ–‡ä»¶ã€‚
* ç‚¹å‡» **å¯¼å…¥** å¯æ¢å¤æ•°æ®æˆ–æ‰¹é‡æ·»åŠ èŠ‚ç‚¹ï¼ˆæ”¯æŒçƒ­æ›´æ–°ï¼Œç¼“å­˜ç«‹å³åˆ·æ–°ï¼‰ã€‚

---

#### **é€Ÿåº¦**

**Cloudflare çº¿è·¯è´¨é‡**ï¼šç”¨æˆ·æœ¬åœ°ç½‘ç»œè¿æ¥åˆ° Cloudflare è¾¹ç¼˜èŠ‚ç‚¹çš„ä¼˜åŠ£ï¼ˆå›½å†…ç§»åŠ¨/è”é€š/ç”µä¿¡ç›´è¿ CF çš„æ•ˆæœå·®å¼‚å¾ˆå¤§ï¼‰ã€‚ä¸€èˆ¬æƒ…å†µä¸‹è”é€šå»¶è¿Ÿæœ€é«˜ ã€å¯ä»¥é€šè¿‡CNAME+è·¯ç”±çš„æ–¹å¼æ¥åŠ é€Ÿã€‘

**CF ä¸ EMBYæºç«™çš„å¯¹ç­‰è¿æ¥**ï¼šCloudflare ç¾å›½/é¦™æ¸¯èŠ‚ç‚¹è¿æ¥ä½  Emby æºç«™æœåŠ¡å™¨ï¼ˆä¾‹å¦‚åœ¨æ–°åŠ å¡æˆ–ç¾è¥¿ï¼‰çš„çº¿è·¯è´¨é‡ã€‚ã€å¯ä»¥é€šè¿‡CNAME+è·¯ç”±çš„æ–¹å¼æ¥åŠ é€Ÿã€‘

**EMBYæºç«™ä¸Šè¡Œå¸¦å®½ **æ— è§£ 

**è½¬ç èƒ½åŠ›**ï¼šå¦‚æœè§¦å‘è½¬ç ï¼Œå–å†³äºæœåŠ¡å™¨ CPU/GPU æ€§èƒ½ã€‚

---



#### **ç¼“å­˜**

**è‡ªåŠ¨åŒºåˆ†**ï¼šåª’ä½“æ–‡ä»¶ï¼ˆä¸ç¼“å­˜ï¼‰å’Œé™æ€èµ„æºï¼ˆå›¾ç‰‡ã€JSã€CSS ç­‰ç¼“å­˜ï¼‰TTL è®¾ä¸º 1 å¤©

Workers Cache API ç¼“å­˜ KV è¯»å–ç»“æœï¼Œå‡å°‘KVè¯»å†™æ¬¡æ•°

ä»£ç ä¼šå°† KV ä¸­çš„èŠ‚ç‚¹é…ç½®ç¼“å­˜åˆ° Cloudflare çš„è¾¹ç¼˜è®¡ç®—ç¼“å­˜ä¸­ï¼ˆ`caches.default`ï¼‰ï¼Œæœ‰æ•ˆæœŸ 60 ç§’ã€‚

---



#### **KVç©ºé—´ä½œç”¨**

**å‚¨å­˜ä»£ç†ä¿¡æ¯**ï¼ˆåç§°ã€ç›®æ ‡ URLã€Secretï¼‰

**è®°å½•ç™»å½•å¤±è´¥çš„ IP å’Œæ¬¡æ•°**ã€‚æŸIP è¿ç»­è¾“é”™ 5 æ¬¡å¯†ç ï¼Œä¼šè¢«é”å®š 15 åˆ†é’Ÿ

---



#### **å¸¸è§403 Access Deniedé—®é¢˜**

1. **è·¯å¾„è®¿é—®é”™è¯¯**ï¼šåå°ç™»å½• /admin ï¼Œç›´æ¥å¤åˆ¶è¿æ¥è®¿é—®å°±å¥½ã€‚EMBYè‡ªå®šä¹‰è·¯å¾„æ— è§£
2. **ç¼ºå°‘ Secret (å¯†é’¥)**ï¼šä½ ç»™èŠ‚ç‚¹è®¾ç½®äº† Secretï¼ˆä¾‹å¦‚ `123`ï¼‰ï¼Œä½†è®¿é—®æ—¶æ²¡æœ‰å¸¦ä¸Šã€‚
   - *æ­£ç¡®è®¿é—®æ–¹å¼ï¼š`domain.com/HK/123`*
   - *é”™è¯¯è®¿é—®æ–¹å¼ï¼š`domain.com/HK`*
3. **KV æœªç»‘å®š**ï¼šå¦‚æœæ²¡æœ‰æ­£ç¡®ç»‘å®š `ENI_KV`ï¼Œè„šæœ¬è¯»å–ä¸åˆ°èŠ‚ç‚¹ä¿¡æ¯ï¼Œä¹Ÿä¼šå¯¼è‡´æ‰¾ä¸åˆ°èŠ‚ç‚¹è€Œæ‹’ç»è®¿é—®ï¼ˆæˆ–æŠ¥ 500 é”™è¯¯ï¼‰ã€‚

---

#### **æ ¸å¿ƒç‰¹æ€§ (Features)**

- **å¤šèŠ‚ç‚¹ç®¡ç†**ï¼šæ”¯æŒé€šè¿‡ç½‘é¡µåå°æ·»åŠ ã€ä¿®æ”¹ã€åˆ é™¤å¤šä¸ª Emby åç«¯èŠ‚ç‚¹ã€‚
- **è·¯å¾„åŠ å¯† (Secret)**ï¼šæ”¯æŒä¸ºèŠ‚ç‚¹è®¾ç½®â€œç§å¯†è·¯å¾„â€ã€‚å¦‚æœè®¾ç½®äº† secretï¼Œåªæœ‰é€šè¿‡ `domain.com/èŠ‚ç‚¹å/å¯†é’¥` æ‰èƒ½è®¿é—®ï¼Œå¦åˆ™ç›´æ¥æ‹’ç»ï¼Œé˜²æ­¢è¢«æ¶æ„æ‰«æã€‚
- **ES Modules æ ‡å‡†**ï¼šé‡‡ç”¨æ–°ç‰ˆ Workers è¯­æ³•ï¼Œæ€§èƒ½æ›´å¥½ï¼Œå¯åŠ¨æ›´å¿«ã€‚
- **æ™ºèƒ½ç¼“å­˜ç­–ç•¥**ï¼šè‡ªåŠ¨åŒºåˆ†æµåª’ä½“æ–‡ä»¶ï¼ˆä¸ç¼“å­˜ï¼‰å’Œé™æ€èµ„æºï¼ˆå›¾ç‰‡ã€JSã€CSS ç­‰å¼ºç¼“å­˜ï¼‰ã€‚
- **WebSocket æ”¯æŒ**ï¼šå®Œç¾æ”¯æŒ Emby çš„å®æ—¶æ¶ˆæ¯å’Œæ§åˆ¶å°åŠŸèƒ½ã€‚
- **KV è¯»å†™ä¼˜åŒ–**ï¼šåˆ©ç”¨ Workers Cache API ç¼“å­˜ KV è¯»å–ç»“æœï¼Œå‡å°‘ KV è¯»å†™è´¹ç”¨ï¼Œé™ä½å»¶è¿Ÿã€‚
- **UI å¼ºåˆ¶åŒ—äº¬æ—¶é—´**ï¼šåå°ç•Œé¢å¼ºåˆ¶ä½¿ç”¨ Asia/Shanghai æ—¶åŒºåˆ¤æ–­æ˜¼å¤œæ¨¡å¼å’Œæ˜¾ç¤ºæ—¶é—´ã€‚


## âš ï¸ æ³¨æ„äº‹é¡¹ä¸å…è´£å£°æ˜

1. **æµåª’ä½“ç¼“å­˜åˆè§„æ€§**ï¼š
æœ¬é¡¹ç›®å·²æ˜¾å¼è®¾ç½® `Cache-Control: no-store` å¹¶ç¦ç”¨äº† Cloudflare å¯¹æµåª’ä½“æ–‡ä»¶çš„ç¼“å­˜ï¼Œç¬¦åˆ Cloudflare æœåŠ¡æ¡æ¬¾ä¸­å…³äºâ€œé HTML å†…å®¹ç¼“å­˜â€çš„è§„å®šã€‚
*ä½†è¯·æ³¨æ„ï¼šå¦‚æœæ‚¨çš„æ—¥å‡æµé‡è¿‡å¤§ï¼ˆå¦‚ TB çº§åˆ«ï¼‰ï¼Œä»å¯èƒ½å› å ç”¨è¿‡å¤šå¸¦å®½è¢« Cloudflare åˆ¤å®šä¸ºæ»¥ç”¨ï¼ˆSection 2.8ï¼‰ã€‚å»ºè®®ä»…ç”¨äºä¸ªäººæˆ–å®¶åº­åˆ†äº«ã€‚*
2. **KV é¢åº¦**ï¼š
ä»£ç ç»è¿‡æ·±åº¦ä¼˜åŒ–ï¼Œæå¤§å‡å°‘äº† KV è¯»å†™ã€‚Cloudflare å…è´¹ç‰ˆæ¯æ—¥ 100,000 æ¬¡è¯»å–é¢åº¦å¯¹äºä¸ªäººä½¿ç”¨ï¼ˆæ—¥å‡æ’­æ”¾ 100 å°æ—¶ä»¥å†…ï¼‰é€šå¸¸æ˜¯ç»°ç»°æœ‰ä½™çš„ã€‚
3. **ç‰©ç†å»¶è¿Ÿ**ï¼š
Worker æœ¬è´¨æ˜¯ä¸­è½¬ä»£ç†ã€‚å¦‚æœæ‚¨çš„æºç«™åœ¨å›½å†…ï¼Œæµé‡è·¯å¾„ä¸º `ç”¨æˆ· -> CFè¾¹ç¼˜(æµ·å¤–) -> CFå›æº -> æºç«™(å›½å†…)`ï¼Œç‰©ç†å»¶è¿Ÿå¿…ç„¶é«˜äºç›´è¿ã€‚å»ºè®®é…åˆ Cloudflare ä¼˜é€‰ IP ä½¿ç”¨ä»¥è·å¾—æœ€ä½³ä½“éªŒã€‚

---

**License**: GNU General Public License v3.0
